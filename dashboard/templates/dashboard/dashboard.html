{% extends 'dashboard/base.html' %}
{% block title %}KPO Dashboard{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
        }
        h2 {
            margin-bottom: 15px;
            border-left: 4px solid #4f8cff;
            padding-left: 10px;
            font-weight: 600;
        }
        .summary-cards {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        .card {
            flex: 1;
            min-width: 220px;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, background 0.3s, color 0.3s;
            color: var(--card-text);
        }
        .card:hover { transform: translateY(-4px); }
        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--card-title);
            margin-bottom: 8px;
        }
        .card-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--card-text);
        }
        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.06);
            transition: background 0.3s, color 0.3s;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        table th, table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--table-border);
            text-align: left;
        }
        table th {
            background: var(--table-th-bg);
            font-weight: 600;
        }
        table tr:hover td {
            background: var(--table-hover);
        }
        canvas {
            background: var(--chart-bg);
            border-radius: 10px;
            padding: 10px;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="card">
            <div class="card-title">Total Projects</div>
            <div class="card-value">{{ projects|length }}</div>
        </div>
        <div class="card">
            <div class="card-title">Total Teams</div>
            <div class="card-value">{{ teams|length }}</div>
        </div>
        <div class="card">
            <div class="card-title">Average KPI Value</div>
            <div class="card-value">
                {% if avg_kpi is not None %}
                    {{ avg_kpi|floatformat:2 }}
                {% else %}
                    -
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Analytics -->
    <div class="section">
        <h2>Analytics</h2>
        <div style="display: flex; gap: 40px; flex-wrap: wrap;">
            <div style="flex:1; min-width:320px;">
                <h3>Project Status Breakdown</h3>
                <canvas id="projectStatusChart"></canvas>
            </div>
            <div style="flex:1; min-width:320px;">
                <h3>KPI Value Distribution</h3>
                <canvas id="kpiValueChart"></canvas>
            </div>
            <div style="flex:1; min-width:320px;">
                <h3>KPI Trend</h3>
                <canvas id="kpiTrendChart"></canvas>
            </div>
        </div>
        <script>
            // === THEME HELPERS ===
            function getChartColors() {
                const dark = document.body.classList.contains('dark-mode');
                return {
                    text: dark ? '#e0e0e0' : '#333',
                    grid: dark ? '#444' : '#ddd',
                };
            }

            function applyThemeToCharts() {
                const colors = getChartColors();
                Chart.defaults.color = colors.text;
                Chart.defaults.borderColor = colors.grid;
                Chart.helpers.each(Chart.instances, function(chart) {
                    chart.update();
                });
            }

            // === CHARTS ===

            // Project Status Chart
            const projectStatusData = {
                labels: [{% for project in projects %}'{{ project.status }}',{% endfor %}],
                datasets: [{
                    label: 'Projects',
                    data: [{% for project in projects %}1,{% endfor %}],
                    backgroundColor: [
                        '#4f8cff','#38e8fa','#f6d365','#fda085',
                        '#2ecc40','#e74c3c','#f1c40f','#9b59b6'
                    ]
                }]
            };
            const statusCounts = {};
            projectStatusData.labels.forEach((s) => {
                statusCounts[s] = (statusCounts[s] || 0) + 1;
            });
            projectStatusData.labels = Object.keys(statusCounts);
            projectStatusData.datasets[0].data = Object.values(statusCounts);
            new Chart(document.getElementById('projectStatusChart'), {
                type: 'doughnut',
                data: projectStatusData,
                options: {responsive:true, plugins:{legend:{position:'bottom'}}}
            });

            // KPI Value Chart
            new Chart(document.getElementById('kpiValueChart'), {
                type: 'bar',
                data: {
                    labels: [{% for kpi in kpis %}'{{ kpi.name }}',{% endfor %}],
                    datasets: [{
                        label: 'KPI Value',
                        data: [{% for kpi in kpis %}{{ kpi.value }},{% endfor %}],
                        backgroundColor: '#4f8cff'
                    }]
                },
                options: {responsive:true, plugins:{legend:{display:false}}}
            });

            // KPI Trend Line Chart
            new Chart(document.getElementById('kpiTrendChart'), {
                type: 'line',
                data: {
                    labels: [{% for kpi in kpis %}'{{ kpi.name }}',{% endfor %}],
                    datasets: [{
                        label: 'KPI Value Trend',
                        data: [{% for kpi in kpis %}{{ kpi.value }},{% endfor %}],
                        borderColor: '#38e8fa',
                        tension: 0.3
                    }]
                },
                options: {responsive:true, plugins:{legend:{display:true}}}
            });

            // === APPLY THEME TO CHARTS ===
            applyThemeToCharts();
            document.getElementById('darkModeToggle')?.addEventListener('click', () => {
                setTimeout(applyThemeToCharts, 100);
            });
        </script>
    </div>

    <!-- Projects -->
    <div class="section">
        <h2>Projects</h2>
        <table>
            <tr><th>Name</th><th>Client</th><th>Status</th><th>Start Date</th><th>End Date</th></tr>
            {% for project in projects %}
            <tr>
                <td>{{ project.name }}</td>
                <td>{{ project.client }}</td>
                <td>{{ project.status }}</td>
                <td>{{ project.start_date }}</td>
                <td>{{ project.end_date|default:'-' }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5">No projects found.</td></tr>
            {% endfor %}
        </table>
    </div>

    <!-- Teams -->
    <div class="section">
        <h2>Teams</h2>
        <table>
            <tr><th>Name</th><th>Members</th><th>Project</th></tr>
            {% for team in teams %}
            <tr>
                <td>{{ team.name }}</td>
                <td>{{ team.members }}</td>
                <td>{{ team.project.name }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3">No teams found.</td></tr>
            {% endfor %}
        </table>
    </div>

    <!-- KPIs -->
    <div class="section">
        <h2>KPIs</h2>
        <table>
            <tr><th>Project</th><th>KPI Name</th><th>Value</th><th>Target</th></tr>
            {% for kpi in kpis %}
            <tr>
                <td>{{ kpi.project.name }}</td>
                <td>{{ kpi.name }}</td>
                <td>{{ kpi.value }}</td>
                <td>{{ kpi.target }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4">No KPIs found.</td></tr>
            {% endfor %}
        </table>
    </div>
{% endblock %}
